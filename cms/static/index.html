<!DOCTYPE html>
<html>
<head>
    <title>Crowd Monitoring System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #f4f6f8;
            --text: #000;
            --card: #ffffff;
            --border: #333;
        }

        body.dark {
            --bg: #121212;
            --text: #e0e0e0;
            --card: #1e1e1e;
            --border: #444;
        }

        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        h1 {
            margin-top: 20px;
        }

        img {
            margin-top: 20px;
            border: 3px solid var(--border);
            border-radius: 8px;
        }

        #alert {
            font-size: 22px;
            font-weight: bold;
            margin-top: 15px;
        }

        .toggle {
            margin-top: 10px;
        }

        .toggle button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .card {
            background: var(--card);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            min-width: 150px;
        }

        canvas {
            max-width: 900px;
            margin: 30px auto;
        }
    </style>
</head>
<body>

<h1> Crowd Monitoring System</h1>

<div class="toggle">
    <button onclick="toggleDark()"> Toggle Dark Mode</button>
</div>

<img src="/video-feed" width="800">

<p id="alert">Crowd Level Normal</p>

<!-- ANALYTICS CARDS -->
<div class="stats">
    <div class="card">
        <h3>Current Crowd</h3>
        <p id="current">0</p>
    </div>
    <div class="card">
        <h3>Average Crowd</h3>
        <p id="average">0</p>
    </div>
    <div class="card">
        <h3>Peak Crowd</h3>
        <p id="peak">0</p>
    </div>
    <div class="card">
        <h3>Status</h3>
        <p id="status">NORMAL</p>
    </div>
</div>

<canvas id="crowdChart"></canvas>

<script>
    function toggleDark() {
        document.body.classList.toggle("dark");
        localStorage.setItem("theme",
            document.body.classList.contains("dark") ? "dark" : "light"
        );
    }

    // Persist theme
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
    }

    const ctx = document.getElementById('crowdChart').getContext('2d');

    const crowdChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Crowd Count',
                    data: [],
                    borderWidth: 3,
                    tension: 0.4,
                    borderColor: 'green'
                },
                {
                    label: 'Crowd Limit',
                    data: [],
                    borderDash: [10, 5],
                    borderWidth: 2,
                    borderColor: 'red'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: getComputedStyle(document.body).color
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: getComputedStyle(document.body).color
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: getComputedStyle(document.body).color
                    }
                }
            }
        }
    });

    setInterval(() => {
        fetch('/crowd-data')
            .then(res => res.json())
            .then(data => {

                crowdChart.data.labels = data.history.map((_, i) => i + 1);
                crowdChart.data.datasets[0].data = data.history;
                crowdChart.data.datasets[1].data =
                    Array(data.history.length).fill(data.limit);

                crowdChart.data.datasets[0].borderColor =
                    data.alert ? "red" : "green";

                crowdChart.update();

                document.getElementById("current").innerText = data.current;
                document.getElementById("average").innerText = data.average;
                document.getElementById("peak").innerText = data.peak;

                const status = document.getElementById("status");
                const alertText = document.getElementById("alert");

                if (data.alert) {
                    status.innerText = "ALERT";
                    status.style.color = "red";
                    alertText.innerText = "âš  ALERT: Crowd Limit Exceeded!";
                    alertText.style.color = "red";
                } else {
                    status.innerText = "NORMAL";
                    status.style.color = "green";
                    alertText.innerText = "Crowd Level Normal";
                    alertText.style.color = "green";
                }
            });
    }, 1000);
</script>

</body>
</html>
